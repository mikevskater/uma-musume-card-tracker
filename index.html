<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Card Tracker</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Uma Musume Support Card Tracker</h1>
            <p>Manage and track your support card collection</p>
        </header>

        <div id="loading" class="loading">Loading card data...</div>
        <div id="error" class="error" style="display: none;"></div>

        <!-- Card Comparison Section (Above Everything) -->
        <div id="comparisonSection" class="comparison-section" style="display: none;">
            <div class="comparison-header">
                <h3>Card Comparison</h3>
                <div class="comparison-actions">
                    <button id="clearComparisonBtn" class="btn btn-secondary btn-sm">Clear All</button>
                    <button id="closeComparisonBtn" class="btn btn-danger btn-sm">Close</button>
                </div>
            </div>
            <div id="comparisonTable" class="comparison-table">
                <!-- Comparison content will be populated by JavaScript -->
            </div>
        </div>

        <!-- Selection Mode Toggle (Right-aligned, Above Main Layout) -->
        <div id="selectionModeSection" class="selection-mode-section" style="display: none;">
            <div class="selection-mode-toggle">
                <label for="comparisonModeToggle">
                    <input type="checkbox" id="comparisonModeToggle"> 
                    Select cards to compare
                    <span class="tooltip" data-tooltip="Enable selection mode to choose multiple cards for side-by-side comparison">ℹ️</span>
                </label>
            </div>
        </div>

        <div class="main-layout" style="display: none;">

            <!-- Sidebar with filters -->
            <div class="sidebar">
                <div id="controls" class="controls">
                    <!-- Basic Filters -->
                    <div class="basic-filters">
                        <h3>Filters</h3>
                        
                        <!-- Multi-Layer Sort Section -->
                        <div class="filter-group">
                            <label>Sort Priority:</label>
                            <div class="multi-sort-container" id="multiSortContainer">
                                <!-- Sort layers will be dynamically added here -->
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm add-sort-btn" id="addSortBtn">
                                <span class="sort-icon">+</span> Add Sort Layer
                            </button>
                        </div>

                        <div class="filter-group">
                            <label>Rarity:</label>
                            <div class="multi-select" id="rarityFilter">
                                <div class="multi-select-trigger">
                                    <span class="multi-select-text">All Rarities</span>
                                    <span class="multi-select-arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <label><input type="checkbox" value="1"> R</label>
                                    <label><input type="checkbox" value="2"> SR</label>
                                    <label><input type="checkbox" value="3"> SSR</label>
                                </div>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Type:</label>
                            <div class="multi-select" id="typeFilter">
                                <div class="multi-select-trigger">
                                    <span class="multi-select-text">All Types</span>
                                    <span class="multi-select-arrow">▼</span>
                                </div>
                                <div class="multi-select-dropdown">
                                    <label><input type="checkbox" value="speed"> Speed</label>
                                    <label><input type="checkbox" value="stamina"> Stamina</label>
                                    <label><input type="checkbox" value="power"> Power</label>
                                    <label><input type="checkbox" value="guts"> Guts</label>
                                    <label><input type="checkbox" value="intelligence"> Wit</label>
                                    <label><input type="checkbox" value="friend"> Friend</label>
                                </div>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label>Owned:</label>
                            <select id="ownedFilter">
                                <option value="">All Cards</option>
                                <option value="owned">Owned Only</option>
                                <option value="unowned">Unowned Only</option>
                            </select>
                        </div>

                        <div class="filter-group">
                            <label for="nameFilter">Search:</label>
                            <input type="text" id="nameFilter" placeholder="Search by character name...">
                        </div>

                        <!-- Level Display Options Section -->
                        <div class="filter-group level-display-section">
                            <label class="section-label">
                                Level Display Options
                                <span class="tooltip" data-tooltip="Control how card levels are displayed and calculated for effect values">ℹ️</span>
                            </label>
                            
                            <div class="level-option">
                                <label for="globalLimitBreak">
                                    Set All LB:
                                    <span class="tooltip" data-tooltip="Override all cards to use the same limit break level for comparison purposes">ℹ️</span>
                                </label>
                                <select id="globalLimitBreak">
                                    <option value="">Default</option>
                                    <option value="0">LB 0</option>
                                    <option value="1">LB 1</option>
                                    <option value="2">LB 2</option>
                                    <option value="3">LB 3</option>
                                    <option value="4">LB 4</option>
                                </select>
                            </div>

                            <div class="level-option">
                                <label for="globalOverrideOwned">
                                    <input type="checkbox" id="globalOverrideOwned"> 
                                    Apply to owned cards
                                    <span class="tooltip" data-tooltip="Whether the global limit break setting affects your owned cards or uses their individual levels">ℹ️</span>
                                </label>
                            </div>

                            <div class="level-option">
                                <label for="showMaxPotential">
                                    <input type="checkbox" id="showMaxPotential"> 
                                    Show Max Potential Levels
                                    <span class="tooltip" data-tooltip="Display effect values at maximum level for each card's current limit break instead of current level">ℹ️</span>
                                </label>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label for="releasedFilter">
                                <input type="checkbox" id="releasedFilter"> 
                                Show Unreleased Cards
                                <span class="tooltip" data-tooltip="Include cards not yet released in English">ℹ️</span>
                            </label>
                        </div>
                    </div>

                    <!-- Advanced Filters (Collapsible) -->
                    <div class="advanced-filters">
                        <button type="button" class="advanced-toggle" id="advancedToggle">
                            <span class="toggle-icon">▼</span>
                            Advanced Filters
                        </button>
                        
                        <div class="advanced-content" id="advancedContent" style="display: none;">
                            <!-- REORDERED: Skill Filters now come FIRST -->
                            <div class="advanced-section">
                                <h4>Skill Filters</h4>
                                <div class="skill-filters">
                                    <div class="filter-group">
                                        <label>Hint Skills:</label>
                                        <div class="multi-select" id="hintSkillFilter">
                                            <div class="multi-select-trigger">
                                                <span class="multi-select-text">Any Hint Skills</span>
                                                <span class="multi-select-arrow">▼</span>
                                            </div>
                                            <div class="multi-select-dropdown" id="hintSkillDropdown">
                                                <!-- Dynamically populated -->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="filter-group">
                                        <label>Event Skills:</label>
                                        <div class="multi-select" id="eventSkillFilter">
                                            <div class="multi-select-trigger">
                                                <span class="multi-select-text">Any Event Skills</span>
                                                <span class="multi-select-arrow">▼</span>
                                            </div>
                                            <div class="multi-select-dropdown" id="eventSkillDropdown">
                                                <!-- Dynamically populated -->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="filter-group">
                                        <label>
                                            Include Skill Types:
                                            <span class="tooltip" data-tooltip="Show only cards with skills of these types (e.g., pacer, debuff, leader)">ℹ️</span>
                                        </label>
                                        <div class="multi-select" id="includeSkillTypeFilter">
                                            <div class="multi-select-trigger">
                                                <span class="multi-select-text">Any Skill Types</span>
                                                <span class="multi-select-arrow">▼</span>
                                            </div>
                                            <div class="multi-select-dropdown" id="includeSkillTypeDropdown">
                                                <!-- Dynamically populated -->
                                            </div>
                                        </div>
                                    </div>

                                    <div class="filter-group">
                                        <label>
                                            Exclude Skill Types:
                                            <span class="tooltip" data-tooltip="Hide cards with skills of these types (e.g., exclude long, leader skills)">ℹ️</span>
                                        </label>
                                        <div class="multi-select" id="excludeSkillTypeFilter">
                                            <div class="multi-select-trigger">
                                                <span class="multi-select-text">No Exclusions</span>
                                                <span class="multi-select-arrow">▼</span>
                                            </div>
                                            <div class="multi-select-dropdown" id="excludeSkillTypeDropdown">
                                                <!-- Dynamically populated -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- REORDERED: Effect Filters now come SECOND -->
                            <div class="advanced-section">
                                <h4>Effect Filters</h4>
                                <div class="effect-filters" id="effectFilters">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>

                            <div class="advanced-actions">
                                <button type="button" class="btn btn-secondary" id="clearAdvancedBtn">Clear Advanced Filters</button>
                            </div>
                        </div>
                    </div>

                    <!-- Card Collection Management -->
                    <div class="data-management">
                        <h4>Card Collection Management</h4>
                        <div class="data-management-buttons">
                            <button id="exportBtn" class="btn btn-secondary">📄 Export Card Collection</button>
                            <input type="file" id="importFile" accept=".json" style="display: none;">
                            <button id="importBtn" class="btn btn-secondary">📂 Import Card Collection</button>
                            <button id="clearBtn" class="btn btn-danger">🗑️ Clear Card Collection</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main content area with proper flex layout for side-by-side comparison -->
            <div class="main-content">
                <!-- Content wrapper contains table and filters (takes most space) -->
                <div class="content-wrapper">
                    <!-- Active Filters Display -->
                    <div id="activeFilters" class="active-filters" style="display: none;">
                        <div class="active-filters-header">
                            <span class="results-count" id="resultsCount">Showing all cards</span>
                            <button class="btn btn-sm btn-secondary" id="clearAllFilters">Clear All Filters</button>
                        </div>
                        <div class="filter-chips" id="filterChips">
                            <!-- Dynamically populated filter chips -->
                        </div>
                    </div>

                    <!-- Card Table -->
                    <div id="cardTable" class="card-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Owned</th>
                                    <th class="sortable" data-sort="icon">Icon <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="name">Card <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="rarity">Rarity <span class="sort-arrow"></span></th>
                                    <th class="sortable" data-sort="type">Type <span class="sort-arrow"></span></th>
                                    <th>Level</th>
                                    <th>Current LB</th>
                                    <th>Primary Effects</th>
                                    <th>Hints</th>
                                    <th class="sortable" data-sort="release">Release <span class="sort-arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="cardTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Selection Container as fixed-width sidebar (only shows when comparison mode is enabled) -->
                <div id="selectionContainer" class="selection-container" style="display: none;">
                    <div class="selection-header">
                        <h4>Selected Cards</h4>
                        <span id="selectionCount" class="selection-count">0 selected</span>
                    </div>
                    <div id="selectedCardsList" class="selected-cards-list">
                        <!-- Selected card icons will be populated here -->
                    </div>
                    <div class="selection-actions">
                        <button id="compareSelectedBtn" class="btn btn-primary btn-sm" disabled>Compare Cards</button>
                        <button id="clearSelectedBtn" class="btn btn-secondary btn-sm">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Card Detail Modal -->
    <div id="cardModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Card Details</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal" style="display: none;">
        <div class="modal-overlay" id="confirmOverlay"></div>
        <div class="modal-content confirm-modal">
            <div class="modal-header">
                <h2 id="confirmTitle">Confirm Action</h2>
                <button class="modal-close" id="confirmClose">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure you want to continue?</p>
                <div class="confirm-buttons">
                    <button id="confirmCancel" class="btn btn-secondary">Cancel</button>
                    <button id="confirmOk" class="btn btn-danger">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Refactored Modular Scripts -->
    <script src="js/utils/dataUtils.js"></script>
    <script src="js/ui/uiComponents.js"></script>
    <script src="js/ui/tableRenderer.js"></script>
    <script src="js/ui/filterSort.js"></script>
    <script src="js/managers/eventManager.js"></script>
    <script src="js/managers/modalManager.js"></script>
    <script src="js/managers/comparisonManager.js"></script>
    <script src="js/managers/cardManager.js"></script>
    <script src="js/app.js"></script>
</body>
</html>